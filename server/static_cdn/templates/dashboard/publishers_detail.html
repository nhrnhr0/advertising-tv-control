{% extends "dashboard/base.html" %}
{% load l10n %}

{% block headcontent %}
<!-- 
        https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.js
        https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.css
        https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js
        https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css
    -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">

<style>
    .delete-button{
        background-color: #ff0000;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px;
        cursor: pointer;
    }
    #toggle-zoom {
        
        margin-bottom: 10px;
    }
    /* floating submit button on the left button side of the screen */
    .submit-button-wraper {
        position: fixed;
        bottom: 40px;
        left: 40px;
        
    }
    .submit-button {
        width: 200px;
        height: 50px;
        background: #2d77e6;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
    }
    .history-button:hover+.history-table,
    .history-button:active+.history-table {
        visibility: visible;
    }


    .history-table {
        position: absolute;
        transform: translate(50%, 0);
        background-color: white;
        visibility: hidden;
        z-index: 1000;
    }

    .history-table:hover {
        visibility: visible;
    }



    .map-container {
        position: relative;
        width: 100%;
        height: 550px;
        max-width: 50vw;
        
        margin-bottom: 50px;
    }

    #map {
        height: 550px;
    }

</style>
{% endblock %}


{% block content %}
<!-- show the details of the publishers (name and broadcasts) -->
<h2>מפרסם: {{publisher.name}}</h2>

{% include "dashboard/components/new_broadcast.html" %}
<h3>שידורים קיימים</h3>
<table>
    <thead>
        <tr>
            <th>id</th>
            <th>מדיה</th>
            <th>שם השידור</th>
            <th>נוצר ב</th>
            <!-- <th>סוג השידור</th> -->
            <th>פעולות</th>
            <th>טלוויזיות</th>
            <th>היסטוריה</th>
        </tr>
    </thead>
    <tbody>
        {% for broadcast in publisher.broadcasts.all %}
        <tr>
            <td>{{broadcast.id}}</td>
            {%if broadcast.deleted %}
                <td colspan="6" style="background-color: #918e8e; color: white;">השידור נמחק
                    <a href="/admin/tv/broadcast/{{broadcast.id}}/change/" target="popup"
                        onclick="window.open('/admin/tv/broadcast/{{broadcast.id}}/change/','popup','width=600,height=600'); return false;">
                        לאדמין
                    </a>
                </td>
            {% else %}
                <td>
                    <a href="{{broadcast.media.url}}" target="popup"
                        onclick="window.open('{{broadcast.media.url}}','popup','width=600,height=600'); return false;">

                    {% if broadcast.media_type == 'image' %}
                    <div class="imageWrapper">
                        <img src="{{broadcast.media.url}}" alt="{{broadcast.name}}">
                    </div>
                    תמונה
                    {% elif broadcast.media_type == 'video' %}
                    <div class="videoWrapper">
                        <!-- <video muted autoplay loop>
                            <source src="{{broadcast.media.url}}" type="video/mp4">
                        </video> -->
                        <video muted onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;" loop>
                            <source src="{{broadcast.media.url}}" type="video/mp4">
                        </video>
                        סרטון
                    </div>
                    {% endif %}
                    </a>
                </td>
            
                <td title="{{broadcast.media.url}}">{{broadcast.name|truncatechars:20}}</td>
                <td>
                    <script type="text/javascript">
                        var date = `{{broadcast.created|date:"c"}}`
                        date = new Date(date);
                        document.write(date.toLocaleString('he-IL', {
                            timeZone: 'Asia/Jerusalem'
                        }));
                    </script>
                </td>
                <!-- <td>{{broadcast.media_type}}</td> -->

                <td>
                    <a href="{{broadcast.get_tv_display_demo_url}}" target="popup"
                        onclick="window.open('{{broadcast.get_tv_display_demo_url}}','popup','width=600,height=600'); return false;">
                        דף דמו
                    </a>
                    <br>
                    <a href="/admin/tv/broadcast/{{broadcast.id}}/change/" target="popup"
                        onclick="window.open('/admin/tv/broadcast/{{broadcast.id}}/change/?_to_field=id&_popup=1','popup','width=600,height=600'); return false;">ערוך</a>
                    <br>
                    <!-- <a href="/admin/tv/broadcast/{{broadcast.id}}/delete/" target="popup"
                        onclick="window.open('/admin/tv/broadcast/{{broadcast.id}}/delete/?_to_field=id&_popup=1','popup','width=600,height=600'); return false;">מחק</a> -->
                        <button class="delete-button" type="button" data-broadcast-id="{{broadcast.id}}"
                        onclick="deleteBroadcast(this)"
                        >מחק
                        </button>

                </td>
                <td>
                    <ul>
                        {% for broad_in_tv in broadcast.get_my_tvs_qs %}
                        <li>
                            <span>
                                <a href="/dashboard/tvs/{{broad_in_tv.tv.id}}/" target="_blank">
                                    {{broad_in_tv.tv}}
                                </a>
                            </span>
                            {% empty %}
                            <span>לא פעיל בשום טלוויזיה</span>
                        </li>
                        {% endfor %}

                    </ul>
                </td>
                <td>
                    <button class="history-button" type="button">
                        היסטוריה ({{broadcast.history|length}})
                    </button>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>
                                    תאריך
                                </th>
                                <th>
                                    טלוויזיה
                                </th>
                                <th>
                                    פעולה
                                </th>
                                <th>
                                    כמות לפני
                                </th>
                                <th>
                                    כמות שהוספה
                                </th>
                                <th>
                                    כמות חדשה
                                </th>
                                <th>
                                    מחיר מכירה
                                </th>
                                <th>
                                    הערה
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- iterate broadcast history in reverse -->
                            {% for history in broadcast.history reversed %}
                            <tr>
                                <td>
                                    <script type="text/javascript">
                                        var date = "{{history.time}}";
                                        date = date.replace("Z", "");
                                        date = new Date(date);
                                        date = new Intl.DateTimeFormat('he-IL', {
                                            year: 'numeric',
                                            month: 'numeric',
                                            day: 'numeric',
                                            hour: 'numeric',
                                            minute: 'numeric',
                                            second: 'numeric',
                                            hour12: false
                                        }).format(date);
                                        document.write(date);
                                    </script>
                                </td>
                                <td>
                                    {{history.tv_name}}
                                </td>
                                <td>
                                    {%if history.action == 'add_to_tv' %}
                                    הוסף לטלוויזיה
                                    {% elif history.action == 'change_left_plays' %}
                                    שינוי כמות
                                    {% endif %}
                                </td>
                                {%if history.action == 'add_to_tv' %}
                                <td>
                                    -
                                </td>
                                <td>
                                    {{history.plays}}
                                </td>
                                <td>
                                    {{history.plays}}
                                </td>
                                {% elif history.action == 'change_left_plays' %}
                                <td>
                                    {{history.plays_before}}
                                </td>
                                <td>
                                    {%if history.plays_added > 0 %}
                                    +{{history.plays_added}}
                                    {% else %}
                                    {{history.plays_added}}
                                    {% endif %}
                                </td>
                                <td>
                                    {{history.plays}}
                                </td>
                                {% endif %}
                                <td>
                                    {%if history.price %}
                                    {{history.price}} ש"ח
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {{history.note}}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </td>
            {%endif%}
        </tr>
        {% endfor %}
    </tbody>
</table>



<form action="/dashboard/publishers/{{publisher.id}}/edit/" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <h2>פרטי המפרסם</h2>
    <div class="map-container">
        <label for="hidden-maps-inputs">אזור עבודה</label>
        <button type="button" id="toggle-zoom" onclick="toggleMapZoom()">הפעל זום</button>
        <div id="map"></div>
        <input type="hidden" id="hidden-maps-inputs" name="geojson" value="{{publisher.geojson}}">
    </div>
    <label for="name">שם המפרסם</label>
    <input type="text" name="name" id="name" value="{{publisher.name}}">
    <br>
    <label for="about">אודות</label>
    <textarea name="about" id="about" cols="30" rows="10">{{publisher.about}}</textarea>
    <br>


    <label for="publishersType">
        סוגי מפרסם
    </label>
    <select name="publishersType" id="publishersTypeSelect" multiple>
        {% for publisher_type in publishers_types %}
        <option value="{{publisher_type.id}}"
            {% if publisher_type in publisher.publishers_types.all %}selected{% endif %}>{{publisher_type.name}}
        </option>
        {% endfor %}
    </select>
    <a href="/admin/core/publishertype/add/" target="popup"
        onclick="window.open('/admin/core/publishertype/add/?_to_field=id&','popup','width=600,height=600'); return false;">הוסף
        סוג מפרסם</a>


    <div>
        <label for="logo">לוגו העסק
        </label>
        {% if publisher.logo %}
        <img src="{{publisher.logo.url}}" alt="logo" width="100px" height="100px">
        {% endif %}
        <input class="input-field" type="file" name="logo" id="logo" accept="image/*">

    </div>


    <!--
    כתובת 
    טלפון
    אימייל
    שם איש קשר
    טלפון איש קשר

    שעות עבודה
    קהל יעד (רשימת הערות)
-->

    <label for="address">כתובת</label>
    <input type="text" name="address" id="address" value="{{publisher.address}}">
    <br>
    <label for="phone">טלפון</label>
    <input type="text" name="phone" id="phone" value="{{publisher.phone}}">
    <br>
    <label for="email">אימייל</label>
    <input type="email" name="email" id="email" value="{{publisher.email}}">
    <br>
    <label for="contact_name">שם איש קשר</label>
    <input type="text" name="contact_name" id="contact_name" value="{{publisher.contact_name}}">
    <br>
    <label for="contact_phone">טלפון איש קשר</label>
    <input type="text" name="contact_phone" id="contact_phone" value="{{publisher.contact_phone}}">
    <br>
    <label for="qr_link">קישור ברירת מחדל לQR של המפרסם</label>
    <input type="text" name="qr_link" id="qr_link" value="{{publisher.qr_link}}">

    <br>
    <label for="משרד פרסום">משרד פרסום</label>
    <select name="adv_agency" id="adv_agency" autocomplete="on">
        <option value="" {% if not publisher.adv_agency %}selected{% endif %}>בחר משרד פרסום</option>
        {% for adv_agency in adv_agencies %}
        <option value="{{adv_agency.id}}" {% if adv_agency == publisher.adv_agency %}selected{% endif %}>
            {{adv_agency.name}}</option>
        {% endfor %}
    </select>
    <br>

    <div class="submit-button-wraper">
        <input type="submit" value="שמור" class="submit-button">
    </div>
</form>

    <!-- <form action="/dashboard/publishers/delete-broadcast" method="post" id="delete-broadcast-form">
        {% csrf_token %}
        <input type="hidden" name="delete_broadcast_id" id="delete_broadcast_id">
    </form> -->

<script type="text/javascript">
    let map = null;
    
    function toggleMapZoom() {
        let new_text = ''
        if(map) {
            if (map.scrollWheelZoom.enabled()) {
                map.scrollWheelZoom.disable();
                new_text = 'הפעל זום'
            } else {
                map.scrollWheelZoom.enable();
                new_text = 'בטל זום'
            }
        }
        document.getElementById('toggle-zoom').innerHTML = new_text;
    }
    function initMap() {
        let originalPolygon = `{{publisher.geojson|safe}}`;
        if (originalPolygon && originalPolygon != "None" && originalPolygon != "{}") {
            originalPolygon = JSON.parse(originalPolygon);
        } else {
            originalPolygon = null;
        }



        var center = [31.37857870948204, 34.69895372415273];

        // Create the map
        map = L.map('map').setView(center, 9.25);

        // Set up the OSM layer
        L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Data © <a href="http://osm.org/copyright">OpenStreetMap</a>',
                // maxZoom: 12,
            }).addTo(map);


        // add the polygon to the map if it exists
        if (originalPolygon) {
            new L.GeoJSON(originalPolygon).addTo(map);
        }

        // add a marker in the given location
        // L.marker(center).addTo(map);

        // Initialise the FeatureGroup to store editable layers
        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        var drawPluginOptions = {
            position: 'topright',
            draw: {
                polygon: {
                    // allowIntersection: false, // Restricts shapes to simple polygons
                    drawError: {
                        color: '#e1e100', // Color the shape will turn when intersects
                        message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                    },
                    shapeOptions: {
                        color: '#97009c'
                    }
                },
                // disable toolbar item by setting it to false
                polyline: false,
                circle: false, // Turns off this drawing tool
                rectangle: false,
                marker: false,
            },
            edit: {
                featureGroup: editableLayers, //REQUIRED!!
                remove: false
            }
        };

        // Initialise the draw control and pass it the FeatureGroup of editable layers
        var drawControl = new L.Control.Draw(drawPluginOptions);
        map.addControl(drawControl);

        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        
        


        map.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;

            if (type === 'polygon') {
                // Do marker specific actions
                let val = JSON.stringify(layer.toGeoJSON())
                console.log(val);
                // create a hidden input with the geojson
                document.getElementById('hidden-maps-inputs').value = val;
            }
            // remove the previous layer
            editableLayers.clearLayers();

            editableLayers.addLayer(layer);
        });

        map.scrollWheelZoom.disable();
    }

    function initAutoComplete() {
        selectBoxTest = new vanillaSelectBox("#publishersTypeSelect", {
            "maxHeight": 200,
            "search": true,
            "size": 5,
            "translations": {
                "all": "הכל",
                "items": "פרטים",
                "selectAll": "בחר הכל",
                "clearAll": "נקה הכל",
                "placeHolder": "סוגי עסק"
            }
        });
    }

    function deleteBroadcast(delBtn) {
        // prompt the user to confirm
        let confirm = window.confirm("האם אתה בטוח שברצונך למחוק את השידור?");
        if (confirm) {
            // delete the broadcast
            let broadcast_id = delBtn.getAttribute('data-broadcast-id');
            // send a post to `/dashboard/publishers/delete-broadcast`
            // with the broadcast id, and csrf token
            let csrf_token = document.getElementsByName('csrfmiddlewaretoken')[0].value;
            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/dashboard/publishers/delete-broadcast');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // remove the broadcast from the page
                    window.location.reload();
                } else {
                    alert('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send(`csrfmiddlewaretoken=${csrf_token}&delete_broadcast_id=${broadcast_id}`);
        }
    }
    initMap();
    initAutoComplete();
</script>

{% endblock %}
{% extends "dashboard/base.html" %}
{% load static %}

{% load l10n %}
{% block headcontent %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">
{%endblock%}


{% block content %}
    <h2>משרד פרסום: {{agency.name}}</h2>
    <form action="/dashboard/advertising-agency/{{agency.id}}/edit/" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- name,address,geojson,phone,email,contact_name,contact_phone,logo,updated,created -->
        <div>
            
            <div class="map-container">
                <label for="geojson">אזור עבודה</label>
                <div id="map"></div>
                <input type="hidden" id="hidden-maps-inputs" name="geojson" value="{{agency.geojson}}">
            </div>
        </div>
        <div>
            <label for="name">שם
            </label>
            <input class="input-field" type="text" name="name" id="name" value="{{agency.name}}">
            <!-- TODO: use google maps api -->
        </div>
        <div>
            <label for="address">כתובת
            </label>
            <input class="input-field" type="text" name="address" id="address" value="{{agency.address}}">
            <!-- TODO: use google maps api -->
        </div>
        
        <div>
            <label for="phone">טלפון
            </label>
            <input class="input-field" type="text" name="phone" id="phone" value="{{agency.phone}}">
        </div>
        <div>
            <label for="email">אימייל
            </label>
            <input class="input-field" type="email" name="email" id="email" value="{{agency.email}}">
        </div>
        <div>
            <label for="contact_name">שם איש קשר
            </label>
            <input class="input-field" type="text" name="contact_name" id="contact_name" value="{{agency.contact_name}}">
        </div>
        <div>
            <label for="contact_phone">טלפון איש קשר
            </label>
            <input class="input-field" type="text" name="contact_phone" id="contact_phone" value="{{agency.contact_phone}}">
        </div>
        
        <div>
            {% if agency.logo %}
                <img src="{{agency.logo.url}}" alt="logo" width="100px" height="100px" class="logo">
            {% endif %}
            <label for="logo">לוגו
            </label>
            
            <input class="input-field" type="file" name="logo" id="logo">
        </div>
        <div>
            <label for="publishers">מפרסמים
            </label>
            <ul>
                {% for pub in agency.publishers.all %}
                    <li>
                        {% if pub.logo %}
                            <img src="{{pub.logo.url}}" alt="logo" width="100px" height="100px" class="logo">
                        {% endif %}
                        <a href="/dashboard/publishers/{{pub.id}}/">{{pub.name}}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <button type="submit">שמור</button>
    </form>
    <style>

.map-container {
  position: relative;
  width: 100%;
  height: 550px;
  max-width: 50vw;
  position: absolute;
  left: 0px;
}
#map {
  height: 550px;
}

    </style>
    
<script type="text/javascript">
    
    function initMap(){
        let originalPolygon = `{{agency.geojson|safe}}`;
        if (originalPolygon && originalPolygon != "None" && originalPolygon != "{}") {
            originalPolygon = JSON.parse(originalPolygon);
        }else {
            originalPolygon = null;
        }
            
        

        var center = [31.37857870948204, 34.69895372415273];

        // Create the map
        var map = L.map('map').setView(center, 9.25);

        // Set up the OSM layer
        L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Data © <a href="http://osm.org/copyright">OpenStreetMap</a>',
            // maxZoom: 12,
        }).addTo(map);


        // add the polygon to the map if it exists
        if (originalPolygon) {
            new L.GeoJSON(originalPolygon).addTo(map);
        }

        // add a marker in the given location
        // L.marker(center).addTo(map);

        // Initialise the FeatureGroup to store editable layers
        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        var drawPluginOptions = {
        position: 'topright',
        draw: {
            polygon: {
            // allowIntersection: false, // Restricts shapes to simple polygons
            drawError: {
                color: '#e1e100', // Color the shape will turn when intersects
                message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
            },
            shapeOptions: {
                color: '#97009c'
            }
            },
            // disable toolbar item by setting it to false
            polyline: false,
            circle: false, // Turns off this drawing tool
            rectangle: false,
            marker: false,
            },
        edit: {
            featureGroup: editableLayers, //REQUIRED!!
            remove: false
        }
        };

        // Initialise the draw control and pass it the FeatureGroup of editable layers
        var drawControl = new L.Control.Draw(drawPluginOptions);
        map.addControl(drawControl);

        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        map.on('draw:created', function(e) {
        var type = e.layerType,
            layer = e.layer;

        if (type === 'polygon') {
            // Do marker specific actions
            let val = JSON.stringify(layer.toGeoJSON())
            console.log(val);
            // create a hidden input with the geojson
            document.getElementById('hidden-maps-inputs').value=val;
        }
        // remove the previous layer
        editableLayers.clearLayers();

        editableLayers.addLayer(layer);
        });
    }
    
    initMap();
</script>
{%endblock%}

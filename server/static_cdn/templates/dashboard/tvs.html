{% extends "dashboard/base.html" %}
{% load static %}
{%block headcontent %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.7/css/tabulator.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.0.7/js/tabulator.min.js"></script>
{% endblock %}
{% block content %}
<!-- show all_publishers as links to their dashboard and option to add new publisher -->
<h2>טלוויזיות</h2>
<!-- <ul>
        {% for tv in all_tvs %}
            <li><a href="/dashboard/tvs/{{tv.id}}">{{tv.name}}</a></li>
        {% endfor %}
    </ul> -->
    <div class="form-actions">
        <button tpye="button" id="select-all" class="btn btn-primary" style="display: inline-block;" onclick="select_all()"
        >בחר הכל</button>
        <!-- button to deselect all -->
        <button tpye="button" id="deselect-all" class="btn btn-secondary" style="display: inline-block;" onclick="deselect_all()"
        >בטל בחירה</button>
        <form action="/dashbaord/tvs-action" method="POST" class="action-form" id="action-form">
        <!-- button to select all -->
        
        <!-- labal of currently selected out of how many -->
        <span id="selected-count" style="display: inline-block; margin: 0 10px;"></span>
        <!-- select box with actions -->
        <select id="action-select" class="form-control" style="width: 200px; display: inline-block;">
            <option value="0">בחר פעולה</option>
            <option value="1">הפק מפת טלוויזיות</option>
        </select>
        <button type="submit" id="action-button" class="btn btn-primary" style="display: inline-block;" onclick="action_button()"
        >בצע</button>
        
            <input type="hidden" name="action-input" id="action-input" value="0">
            <input type="hidden" name="action-selected-rows" id="action-selected-rows" value="">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        </form>
    </div>
<table id="example-table" class="table table-striped table-bordered" style="width:100%">
    <thead>
        <tr>
            <th>
                #
            </th>
            <th>
                שם
            </th>
            <th>
                כתובת
            </th>
            <th>
                לוגו
            </th>
            <th>
                שידורים פעילים / הכל
            </th>
            <th>
                שעות פעילות
            </th>
            <th>
                סוגי עסק
            </th>
            <th>
                לפי השעות פתיחה
            </th>
            <th>
                PI
            </th>
        </tr>
    </thead>
    <tbody>
        {% for tv in all_tvs %}
        <tr>
            <td onclick="row_click(this)">
                <input type="checkbox" name="selected_rows" value="{{tv.id}}" class="select-row" style="display: none;">
                <div>
                {{forloop.counter}}
                </div>
            </td>
            <td>
                <a href="/dashboard/tvs/{{tv.id}}">{{tv.name}}</a>
            </td>
            <td>
                {{tv.address}}
            </td>
            <td>
                {%if tv.logo %}
                <img src="{{tv.logo.url}}" alt="logo" width="100" height="100">
                {%else%}
                <img src="{% static 'imgs/no_image.png' %}" alt="logo" width="100" height="100">
                {%endif%}
            </td>
            <td>
                {{tv.active_broadcasts|length}} /
                {{tv.get_broadcasts|length}}
            </td>
            <td>
                {{tv.opening_hours.all|join:"<br>"|safe}}
            </td>
            <td>
                {{tv.buisness_types.all|join:"<br>"|safe}}
            </td>
            <td>
                {% if tv.is_opening_hours_active %}
                <img src="{% static 'admin/img/icon-yes.svg' %}" alt="yes" width="10" height="10">
                פתוח
                {% else %}
                <img src="{% static 'admin/img/icon-no.svg' %}" alt="no" width="10" height="10">
                סגור
                {% endif %}
            </td>
            <td>
                {% if tv.pi %}
                    פיי: 
                        {% if tv.pi.is_socket_connected_live %}
                            <img src="{% static 'admin/img/icon-yes.svg' %}" alt="yes" width="10" height="10">
                            מחובר
                        {% else %}
                            <img src="{% static 'admin/img/icon-no.svg' %}" alt="no" width="10" height="10">
                            לא מחובר
                        {% endif %}
                    <br>
                    טלוויזיה:
                    {% if tv.pi.cec_hdmi_status == 'on' %}
                        <img src="{% static 'admin/img/icon-yes.svg' %}" alt="yes" width="10" height="10">
                        פועלת
                    {% else %}
                        <img src="{% static 'admin/img/icon-no.svg' %}" alt="no" width="10" height="10">
                        {{tv.pi.cec_hdmi_status}}
                    {% endif %}
                    <br>
                    עדכן אחרון ב: {{tv.pi.socket_status_updated}}
                    <br>
                    לפני: {{tv.pi.humanize_socket_status_updated_ago}}
                    <br>
                    <a href="/admin/pi/pidevice/?device_id={{tv.pi.device_id}}" target="popup"
                        onclick="window.open('/admin/pi/pidevice/?device_id={{tv.pi.device_id}}','popup','width=600,height=600'); return false;">לאדמין
                        הפיי</a>
                        <br>
                        {% if tv.pi.remote_last_image %}
                            <img src="{{tv.pi.remote_last_image.url}}" alt="remote" width="100" height="100">
                        {%endif%}
                    <br>
                    {%if tv.pi.humanize_image_updated_ago%}
                        תמונה עודכנה לפני: {{tv.pi.humanize_image_updated_ago}}
                        <br>
                    {%endif%}
                {% else %}
                    Pi לא מוגדר
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% include "dashboard/components/new_tv.html" %}

<script >
    function update_selected_count() {
        let all_checkboxes = document.querySelectorAll('input[type="checkbox"].select-row');
        let selected_count = 0;
        for (let i = 0; i < all_checkboxes.length; i++) {
            if (all_checkboxes[i].checked) {
                selected_count++;
            }
        }
        if (selected_count > 0) {
            document.getElementById('action-button').style.display = 'inline-block';
        } else {
            document.getElementById('action-button').style.display = 'none';
        }
        document.getElementById('selected-count').innerHTML = selected_count + ' / ' + all_checkboxes.length;
        

    }

    function row_click(td) {
        let row = td.closest('tr');
        debugger;
        var checkbox = row.querySelector('input[type="checkbox"].select-row');
        checkbox.checked = !checkbox.checked;
        update_selected_count();

    }

    function select_all() {
        let all_checkboxes = document.querySelectorAll('input[type="checkbox"].select-row');
        for (let i = 0; i < all_checkboxes.length; i++) {
            all_checkboxes[i].checked = true;
        }
        update_selected_count();
    }
    function deselect_all() {
        let all_checkboxes = document.querySelectorAll('input[type="checkbox"].select-row');
        for (let i = 0; i < all_checkboxes.length; i++) {
            all_checkboxes[i].checked = false;
        }
        update_selected_count();
    }

    function action_button() {
        let all_checkboxes = document.querySelectorAll('input[type="checkbox"].select-row');
        let selected_ids = [];
        for (let i = 0; i < all_checkboxes.length; i++) {
            if (all_checkboxes[i].checked) {
                selected_ids.push(all_checkboxes[i].value);
            }
        }
        // send the selected ids as array and the action to the server in a post request in the action form includeing the csrf token
        let form = document.getElementById('action-form');

        // add the selected ids to the form (selected_rows[])
        let new_value = selected_ids.join(',');
        form.querySelector('input[name="action-selected-rows"]').value = new_value;
        // submit the form
        form.submit();

    }
</script>
<style>
    table thead th {
        word-break: break-all;
        padding: 5px;
        text-align: center;
    }

     /* color in diffrent color all tds next to a checked select-row checkbox */
    table tbody tr td {
        padding: 5px;
        text-align: center;
        background-color: #fff;
    }
    input[type="checkbox"].select-row:checked + div {
        background-color: rgb(100, 100, 224);
    }
</style>
{% endblock %}